<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作业上传测试 (Cloudflare Worker)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义加载动画 */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto max-w-2xl p-6">
        <div class="bg-white rounded-lg shadow-xl p-8 mt-10">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
                📚 作业批改 Worker 测试
            </h1>

            <form id="uploadForm" class="space-y-6">
                <div>
                    <label for="workerUrl" class="block text-sm font-medium text-gray-700 mb-1">
                        Worker URL:
                    </label>
                    <input 
                        type="text" 
                        id="workerUrl" 
                        name="workerUrl" 
                        placeholder="例如: https://homework-grader.your-account.workers.dev" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>

                <div>
                    <label for="homeworkFile" class="block text-sm font-medium text-gray-700 mb-1">
                        选择作业 .zip 包:
                    </label>
                    <input 
                        type="file" 
                        id="homeworkFile" 
                        name="homeworkFile" 
                        accept=".zip" 
                        required 
                        class="w-full text-sm text-gray-500
                               file:mr-4 file:py-2 file:px-4
                               file:rounded-md file:border-0
                               file:text-sm file:font-semibold
                               file:bg-blue-50 file:text-blue-700
                               hover:file:bg-blue-100
                               focus:outline-none"
                    >
                </div>

                <button 
                    type="submit" 
                    id="submitButton" 
                    class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
                >
                    <span id="buttonText">上传并批改</span>
                    <div id="loadingSpinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
                </button>
            </form>

            <!-- 结果显示区域 -->
            <div id="resultContainer" class="mt-6 hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">处理结果:</h2>
                <pre id="resultOutput" class="bg-gray-900 text-white text-sm rounded-md p-4 overflow-x-auto"></pre>
            </div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultContainer = document.getElementById('resultContainer');
        const resultOutput = document.getElementById('resultOutput');
        const workerUrlInput = document.getElementById('workerUrl');
        const fileInput = document.getElementById('homeworkFile');

        // 在页面加载时尝试从 localStorage 加载 URL
        workerUrlInput.value = localStorage.getItem('workerUrl') || '';

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // 阻止表单默认提交

            const workerUrl = workerUrlInput.value.trim();
            const file = fileInput.files[0];

            if (!workerUrl || !file) {
                alert('请填写 Worker URL 并选择一个 .zip 文件。');
                return;
            }
            
            // 保存 URL 到 localStorage 以便下次使用
            localStorage.setItem('workerUrl', workerUrl);

            // 禁用按钮并显示加载动画
            submitButton.disabled = true;
            buttonText.textContent = '处理中...';
            loadingSpinner.classList.remove('hidden');
            resultContainer.classList.add('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(workerUrl, {
                    method: 'POST',
                    body: formData,
                });

                const resultText = await response.text();

                // 显示结果
                resultContainer.classList.remove('hidden');
                
                if (response.ok) {
                    // 尝试解析 JSON
                    try {
                        const jsonResult = JSON.parse(resultText);
                        resultOutput.textContent = JSON.stringify(jsonResult, null, 2);
                        resultOutput.classList.remove('text-red-400');
                        resultOutput.classList.add('text-white');
                    } catch (e) {
                        // 如果不是 JSON，就显示原始文本
                        resultOutput.textContent = resultText;
                        resultOutput.classList.remove('text-red-400');
                        resultOutput.classList.add('text-white');
                    }
                } else {
                    // 处理错误
                    resultOutput.textContent = `错误 ${response.status}: ${resultText}`;
                    resultOutput.classList.remove('text-white');
                    resultOutput.classList.add('text-red-400');
                }

            } catch (error) {
                // 处理网络或其他 fetch 错误
                resultContainer.classList.remove('hidden');
                resultOutput.textContent = `Fetch 错误: ${error.message}\n\n请检查 Worker URL 是否正确，以及 Worker 是否已成功部署。`;
                resultOutput.classList.remove('text-white');
                resultOutput.classList.add('text-red-400');
            } finally {
                // 恢复按钮状态
                submitButton.disabled = false;
                buttonText.textContent = '上传并批改';
                loadingSpinner.classList.add('hidden');
            }
        });
    </script>

</body>
</html>

